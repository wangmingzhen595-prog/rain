<!-- c1546bda-1f22-4b17-b4aa-2b9bccfb18fb bf6bb551-6e8c-4ba4-83b0-51f62a931a04 -->
# 双增益峰值与预触发改造

## 任务拆解

- **gain-switch**：在 [Hardware/AD.c](Hardware/AD.c) / [User/stm32f10x_it.c](User/stm32f10x_it.c) 中约定 CH0 为高增益、CH1 为低增益，引入可配置宏（如 `HIGH_GAIN_FACTOR`、`LOW_GAIN_FACTOR`）。在快照与峰值评估阶段增加“优先高增益、饱和则回退低增益”的逻辑：记录高增益是否饱和（>=3.3V 或近饱和阈值），若饱和则使用低增益样本作为 `current_peak/current_voltage`，否则使用高增益，同时把最终有效值回推到原始电压（考虑增益倍率）。
- **pulse-length**：在 [User/stm32f10x_it.c](User/stm32f10x_it.c) 的状态机里追踪“上升起点→峰值→回落到基线”这一段样本数（可记录索引差或样本计数），并在 `Process_Snapshot_IfReady` / 验证逻辑中忽略峰值之后的负向段：一旦波形跌回基线即终止分析。把长度统计结果存入全局变量，留给后续调试（如 OLED 或串口显示）。
- **watchdog-pretrigger**：复用现有环形缓冲架构，将 `SNAPSHOT_PRE_SAMPLES`/`SNAPSHOT_POST_SAMPLES` 宏设为 200/800，总计 1000。DMA 持续写入环形缓冲，但不刷新 OLED。模拟看门狗触发时获取当前 ring index，拷贝 200 点历史数据，然后在 DMA 中断继续填充 800 点后触发数据；完成后交给 `Process_Snapshot_IfReady` 处理峰值。通过宏让之后调整点数更容易。

## 实施要点

- 在 `main.c` 中新增配置注释，说明两个增益通道的用途与饱和切换策略，便于后期调参。
- 确保 `Validate_And_Count_Event` 接受“有效波形长度”信息（或只遍历起止索引），避免分析负半周。
- 更新 OLED 或调试输出（若需要）以显示当前使用的增益通道、测得的有效脉冲长度。

### To-dos

- [x] 移除 Process_ADC_Data 及双通道遗留逻辑
- [x] 合并双通道状态机并统一计数
- [x] 更新显示为单通道输出
- [x] 记录峰值保证与尾迹处理方案