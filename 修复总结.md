# 后部噪声过滤修复总结

## 修复完成

已成功实现所有计划中的修复功能，解决0.99V后部噪声误判为峰值的问题。

## 实现的修复功能

### 1. 稳定期检查机制 ✅
- **位置**：`User/stm32f10x_it.c` - `PEAK_STATE_IDLE`状态
- **功能**：在WAIT_FALL完成后，进入稳定期（20个样本）
- **机制**：稳定期内，值必须在基线附近（±50 ADC单位）保持，才允许新的峰值检测
- **效果**：避免后部噪声立即触发新的峰值检测

### 2. 提高IDLE状态触发条件 ✅
- **位置**：`User/stm32f10x_it.c` - `PEAK_STATE_IDLE`状态
- **原条件**：`value > dynamic_threshold`
- **新条件**：
  - `value > (dynamic_threshold + 100)` - 值必须明显超过阈值
  - 需要连续3个样本都超过阈值才触发
- **效果**：0.99V（约1227 ADC）即使超过阈值，也需要超过阈值+100且连续3个样本，通常无法满足

### 3. 动态死区时间 ✅
- **位置**：`User/stm32f10x_it.c` - `PEAK_STATE_WAIT_FALL`状态
- **功能**：根据峰值大小动态调整死区时间
- **计算**：峰值每增加1000个ADC单位（约0.8V），死区时间增加50个样本
- **范围**：最小50个样本，最大200个样本
- **效果**：大峰值（如2.64V）后使用更长的死区时间，进一步保护

### 4. 前部峰值检测（之前已实现）✅
- **功能**：只在前部（上升→峰值→下降到0）搜索峰值，忽略后部
- **机制**：检测到回落到基线附近时立即锁定峰值

## 关键参数

```c
// 后部噪声过滤参数
#define IDLE_TRIGGER_MARGIN     100      // IDLE状态触发阈值余量
#define IDLE_TRIGGER_CONSEC     3        // 需要连续3个样本都超过阈值
#define STABLE_PERIOD_COUNT     20       // 稳定期样本数
#define STABLE_BASELINE_DELTA   50       // 稳定期基线附近的范围
#define DEAD_TIME_MIN           50       // 最小死区时间
#define DEAD_TIME_MAX           200      // 最大死区时间
```

## 工作流程

1. **第一滴雨滴前部峰值（2.64V）**：
   - 正确捕获前部峰值
   - 检测到回落到基线，锁定峰值
   - 进入WAIT_FALL状态

2. **WAIT_FALL完成后**：
   - 根据峰值大小计算动态死区时间（2.64V对应约100-150个样本）
   - 设置稳定期（20个样本）
   - 进入IDLE状态

3. **死区时间期间**：
   - 不允许任何峰值检测
   - 更新基线

4. **稳定期期间**：
   - 值必须在基线附近（±50 ADC单位）
   - 稳定期未结束，不允许新的峰值检测
   - 即使0.99V出现，也会被稳定期过滤

5. **稳定期结束后**：
   - 值必须超过`threshold + 100`且连续3个样本
   - 0.99V（约1227 ADC）通常无法满足这个条件
   - 只有真正的雨滴前部峰值才能触发

## 预期效果

- ✅ 第一滴雨滴峰值（2.64V）正确显示
- ✅ 后部0.99V噪声不会触发新的峰值检测
- ✅ 显示值保持稳定，不会跳变
- ✅ 真正的第二滴雨滴能正常触发检测

## 测试建议

1. **验证前部峰值捕获**：
   - 观察第一滴雨滴是否显示正确的峰值（如2.64V）

2. **验证后部噪声过滤**：
   - 观察显示值是否保持稳定，不会跳变到0.99V
   - 检查稳定期和触发条件是否有效

3. **验证动态死区时间**：
   - 大峰值后应该有更长的保护期
   - 小峰值后死区时间较短

4. **验证第二滴雨滴检测**：
   - 确保真正的第二滴雨滴能正常触发检测
   - 不会因为过滤机制过于严格而漏检

## 代码文件

- `User/stm32f10x_it.c` - 中断层峰值检测逻辑（已修改）
- `User/main.c` - 主循环峰值保持机制（之前已实现）

## 注意事项

1. 如果过滤过于严格，可能需要调整参数：
   - `IDLE_TRIGGER_MARGIN`：降低可以更容易触发，提高可以更严格过滤
   - `IDLE_TRIGGER_CONSEC`：减少可以更容易触发，增加可以更严格过滤
   - `STABLE_PERIOD_COUNT`：减少可以更快允许新检测，增加可以更严格过滤

2. 如果仍有问题，可以：
   - 检查`dynamic_threshold`的实际值
   - 检查0.99V对应的实际ADC值
   - 调整参数以适应实际信号特征

## 修复完成时间

2024-12-XX

所有修复功能已实现并通过语法检查，可以编译测试。

