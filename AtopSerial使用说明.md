# AtopSerial 雨滴脉冲波形绘图使用说明

## 概述
本系统用于通过AtopSerial软件接收STM32单片机发送的雨滴脉冲信号数据，并实时绘制波形图。

## 数据格式
- **帧头**：0xAA 0x55
- **长度**：2字节（小端格式，低字节在前）
- **数据**：uint16数组（每个值2字节，小端格式）
- **样本数**：通常为500个（SNAPSHOT_SIZE）

## 使用方法

### 方法一：推荐方案（两个脚本配合）

#### 步骤1：设置接收预处理脚本
1. 打开AtopSerial软件
2. 点击"接收预处理脚本"标签
3. 新建脚本，粘贴 `接收预处理脚本_雨滴波形_自动解析.lua` 的内容
4. 脚本会自动运行，无需手动启动

#### 步骤2：设置运行脚本
1. 在AtopSerial中，点击"运行脚本"标签
2. 新建脚本，粘贴 `运行脚本_雨滴波形绘图_完整版.lua` 的内容
3. 脚本会自动运行，开始绘图

#### 步骤3：连接串口
1. 在AtopSerial中配置串口参数：
   - 波特率：115200
   - 数据位：8
   - 停止位：1
   - 校验位：无
2. 打开串口
3. 确保STM32已发送数据（发送'S'命令启动数据流）

### 方法二：单脚本方案（如果AtopSerial支持）

如果您的AtopSerial版本支持在运行脚本中直接读取串口数据，可以使用 `运行脚本_雨滴波形绘图_完整版.lua`，它会自动尝试从多种来源获取数据。

## 脚本说明

### 1. 接收预处理脚本_雨滴波形_自动解析.lua
- **功能**：自动解析串口接收的原始数据包
- **输入**：串口原始字节流
- **输出**：解析后的波形数据存储在全局变量中
- **特点**：
  - 自动运行，无需手动调用
  - 状态机解析，支持数据包不完整的情况
  - 自动计算峰值、电压等信息

### 2. 运行脚本_雨滴波形绘图_完整版.lua
- **功能**：从全局变量读取解析好的数据并绘制波形
- **特点**：
  - 自动检测数据来源（预处理脚本或直接串口）
  - 实时绘制波形图
  - 每帧自动清空重画，显示最新波形
  - 显示峰值、电压等信息

## 工作流程

```
STM32串口发送
    ↓
[0xAA 0x55] [len_low] [len_high] [数据...]
    ↓
接收预处理脚本（自动解析）
    ↓
全局变量：_G.raindrop_samples, _G.raindrop_ready
    ↓
运行脚本（读取并绘图）
    ↓
AtopSerial绘图窗口显示波形
```

## 常见问题

### Q1: 看不到波形？
- 检查串口是否已打开
- 检查STM32是否在发送数据（发送'S'命令）
- 检查接收预处理脚本是否正在运行
- 查看控制台输出，确认是否有数据接收

### Q2: 波形显示不正确？
- 检查串口波特率是否为115200
- 检查数据格式是否正确（帧头0xAA 0x55）
- 查看控制台输出的解析信息

### Q3: 脚本报错？
- 确认AtopSerial版本支持绘图API（apiPlotInitialize等）
- 检查Lua脚本语法是否正确
- 查看错误信息，定位问题

### Q4: 数据接收不完整？
- 检查串口缓冲区大小设置
- 检查STM32发送速度是否过快
- 尝试降低发送频率

## 调试技巧

1. **查看控制台输出**：脚本会输出解析和绘图信息，帮助定位问题
2. **检查全局变量**：可以在AtopSerial的调试窗口中查看 `_G.raindrop_*` 变量
3. **单步调试**：可以在脚本中设置断点，逐步执行

## 注意事项

1. **无需手动修改**：所有脚本都已配置好，直接粘贴使用即可
2. **自动运行**：接收预处理脚本和运行脚本都会自动运行，无需手动启动
3. **数据格式**：确保STM32发送的数据格式与脚本期望的格式一致
4. **性能**：如果数据量很大，可能需要调整延时参数

## 技术支持

如有问题，请检查：
1. AtopSerial版本是否支持绘图功能
2. 串口连接是否正常
3. STM32程序是否正确配置串口发送
4. 数据格式是否匹配

